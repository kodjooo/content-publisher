#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron –∑–∞–¥–∞—á–∏ email-processor
# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è production —Å—Ä–µ–¥—ã —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

# –í–ê–ñ–ù–û: –ò–∑–º–µ–Ω–∏—Ç–µ –ø—É—Ç—å –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—É—Ç—å –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ
PROJECT_DIR="/usr/local/other-scripts/email-processor"
CRON_SCRIPT="$PROJECT_DIR/run_email_processor.sh"

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á–∏ –¥–ª—è email-processor ==="
echo "–ü—Ä–æ–µ–∫—Ç: $PROJECT_DIR"
echo "–°–∫—Ä–∏–ø—Ç: $CRON_SCRIPT"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "$PROJECT_DIR" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ $PROJECT_DIR –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ PROJECT_DIR –≤ —Å–∫—Ä–∏–ø—Ç–µ"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–ø—É—Å–∫–∞
if [ ! -f "$CRON_SCRIPT" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç $CRON_SCRIPT –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª run_email_processor.sh —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
if [ ! -x "$CRON_SCRIPT" ]; then
    echo "üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞..."
    chmod +x "$CRON_SCRIPT"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ"
        exit 1
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Docker
if ! command -v docker >/dev/null 2>&1; then
    echo "‚ùå –û–®–ò–ë–ö–ê: Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π cron"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è cron –∑–∞–¥–∞—á
TEMP_CRON=$(mktemp)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö cron –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
crontab -l 2>/dev/null > "$TEMP_CRON"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–¥–∞—á email-processor
if grep -q "email-processor" "$TEMP_CRON"; then
    echo "‚ö†Ô∏è  –ó–∞–¥–∞—á–∞ –¥–ª—è email-processor —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ cron:"
    echo ""
    grep "email-processor" "$TEMP_CRON" | sed 's/^/   /'
    echo ""
    
    read -p "–ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É? (y/N): " confirm
    if [[ $confirm == [yY] || $confirm == [yY][eE][sS] ]]; then
        # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á email-processor
        grep -v "email-processor" "$TEMP_CRON" > "${TEMP_CRON}.tmp"
        mv "${TEMP_CRON}.tmp" "$TEMP_CRON"
        echo "‚úÖ –°—Ç–∞—Ä–∞—è –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞"
    else
        echo "üö´ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        rm -f "$TEMP_CRON"
        exit 0
    fi
fi

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π cron –∑–∞–¥–∞—á–∏
echo "" >> "$TEMP_CRON"
echo "# Email processor - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 12:00 –ú–°–ö" >> "$TEMP_CRON"
echo "# –í—Ä–µ–º—è: 09:00 UTC = 12:00 –ú–°–ö (–ª–µ—Ç–Ω–µ–µ –≤—Ä–µ–º—è)" >> "$TEMP_CRON"
echo "# –õ–æ–≥–∏: $PROJECT_DIR/cron.log" >> "$TEMP_CRON"
echo "0 9 * * * $CRON_SCRIPT >/dev/null 2>&1" >> "$TEMP_CRON"
echo "" >> "$TEMP_CRON"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo "# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker (–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 02:00)" >> "$TEMP_CRON"
echo "0 2 * * 0 docker system prune -f >/dev/null 2>&1" >> "$TEMP_CRON"
echo "" >> "$TEMP_CRON"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–π cron —Ç–∞–±–ª–∏—Ü—ã
if crontab "$TEMP_CRON"; then
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!"
    echo ""
    echo "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
    echo "   –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 09:00 UTC (12:00 –ú–°–ö –ª–µ—Ç–æ–º)"
    echo "   –û—á–∏—Å—Ç–∫–∞ Docker:  –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 02:00 UTC"
    echo ""
    echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:"
    echo "   –õ–æ–≥–∏ cron:       tail -f $PROJECT_DIR/cron.log"
    echo "   –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: docker compose -f $PROJECT_DIR/docker-compose.yml run --rm email-processor tail -f /app/logs/email_processor.log"
    echo ""
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û –¥–ª—è –∑–∏–º–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ—è–±—Ä—å-—Ñ–µ–≤—Ä–∞–ª—å):"
    echo "   –ò–∑–º–µ–Ω–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞: 0 8 * * * (08:00 UTC = 12:00 –ú–°–ö –∑–∏–º–æ–π)"
    echo "   –ö–æ–º–∞–Ω–¥–∞: crontab -e"
    echo ""
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ cron –∑–∞–¥–∞—á–∏
    echo "üìã –¢–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏:"
    crontab -l | grep -E "(email-processor|docker system prune|^[^#])" | sed 's/^/   /'
    
else
    echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cron –∑–∞–¥–∞—á—É"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
    rm -f "$TEMP_CRON"
    exit 1
fi

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
rm -f "$TEMP_CRON"

echo ""
echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! ==="
echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö cron –∑–∞–¥–∞—á:    crontab -l"
echo "   –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ cron:         crontab -e"
echo "   –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö cron –∑–∞–¥–∞—á:    crontab -r"
echo "   –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫:             $CRON_SCRIPT"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:              tail -f $PROJECT_DIR/cron.log"
echo "   –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫:                grep -i error $PROJECT_DIR/cron.log"
echo ""
echo "üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ .env —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω: $PROJECT_DIR/.env"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫: $CRON_SCRIPT"
echo "   3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤ 12:00 –ú–°–ö"
echo ""
