Архитектура модуля публикаций
==============================

Общее описание
--------------
Сервис запускается через `python -m publisher.run`. Точка входа загружает конфигурацию из `.env`, настраивает JSON-логирование и создаёт все клиентские объекты. Центральный компонент `PublisherService` координирует обработку трёх потоков публикаций (RSS, VK, Setka), взаимодействуя с Google Sheets и внешними API.

Компоненты
----------
- `publisher/config.py` — загрузка и валидация переменных окружения, формирование структур конфигурации.
- `publisher/core/logger.py` — настройка JSON-логирования на stdout для централизованного сбора логов.
- `publisher/core/retry.py` — обёртка над `tenacity` для повторов сетевых запросов.
- `publisher/gs/sheets.py` — клиент Google Sheets: чтение строк по вкладкам, обновление статусов, ссылок и заметок об ошибках (`Notes` / `Publish Note`).
- `publisher/telegraph/client.py` — работа с Telegra.ph: создание аккаунта при отсутствии токена и публикация длинных материалов.
- `publisher/vk/client.py` — клиент VK API: загрузка изображений и публикация постов на стене сообщества.
- `publisher/tg/client.py` — клиент Telegram Bot API: публикация сообщений с изображением и ограничением длины подписи.
- `publisher/services/publisher.py` — бизнес-логика, объединяющая все клиенты и реализующая последовательности публикаций.
- `publisher/run.py` — точка входа, инициализирующая сервис.

Потоки обработки
----------------
1. **RSS**  
   - Чтение строк со статусом `Revised` на вкладке RSS.  
   - Создание страницы в Telegra.ph, если ссылка отсутствует.  
   - Формирование короткого текста с добавлением ссылки.  
   - Публикация в VK-сообщество и Telegram, сбор ссылок.  
   - Запись ссылок и установка статуса `Published` в таблице.
2. **VK**  
   - Чтение строк со статусом `Revised` на вкладке VK.  
   - Публикация заголовка и содержимого в VK-сообщество.  
   - Сохранение ссылки в `Post Link`, очистка `Publish Note`, установка статуса `Published`.
3. **Setka**  
   - Чтение строк со статусом `Revised` на вкладке Setka.  
   - Публикация сообщения в Telegram-канал.  
   - Запись ссылки в `Post Link`, очистка `Publish Note`, установка статуса `Published`.

При ошибках запись не обновляется; сообщение сохраняется в колонке `Notes` (RSS) или `Publish Note` (VK/Setka), а лог содержит подробности в формате JSON.

Конфигурация и секреты
----------------------
Переменные окружения перечислены в `.env.example` и `.env`. Путь к сервисному аккаунту Google ожидается по значению `GOOGLE_SERVICE_ACCOUNT_JSON`. Чувствительные данные (токены) заполняются вне репозитория. Уровень логирования задаётся переменной `LOG_LEVEL`.

Повторы и устойчивость
----------------------
HTTP-запросы к внешним API защищены ретраями (до трёх попыток) с экспоненциальной паузой. Клиент Google Sheets работает аналогичным образом для чтения и записи. Все ошибки логируются, что облегчает диагностику.

Развёртывание
-------------
`Dockerfile` собирает образ на основе `python:3.11-slim`, устанавливает зависимости из `requirements.txt`, копирует код и запускает модуль `publisher.run`. Для локальной разработки используется `docker-compose.yml` из требований с монтированием каталога логов.
